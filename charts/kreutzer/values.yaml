# Default values for kreutzer.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

global:
  kubeVersion: ""
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

kubeVersion: ""

clusterDomain: cluster.local

commonAnnotations: {}

diagnosticMode:
  enabled: false

imagePullSecrets: []

nameOverride: ""
fullnameOverride: ""

logLevel: debug

serviceAccount:
  create: true
  annotations: {}
  name: ""

exposureType: Ingress

service:
  core:
    type: ClusterIP
    ports:
      http: 80
      https: 443

ingress:
  core:
    hostname: core.domain.com
    path: /api/(.*)
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: /$1
      nginx.ingress.kubernetes.io/use-regex: "true"
  portal:
    hostname: core.domain.com
    annotations: {}
    tls: false


persistence:
  enabled: true
  resourcePolicy: 'keep'
  persistentVolumeClaim: {}
  accessModes:
    - ReadOnlyMany

volumePermissions:
  enabled: false

components:
  portal:
    enabled: true
    type: Deployment
    image:
      repository: nginx:latest
    ports:
      http: 80
    configMaps:
      portal-config:
        type: File
        projectPath: conf/nginx.conf
        mountPath: /etc/nginx/nginx.conf

  core:
    enabled: true
    type: Deployment
    image:
      repository: busybox:1.30.1
    ports:
      http: 8080
  database:
    enabled: true
    type: StatefulSet
    image:
      repository: postgres
      tag: 15.1-alpine
    command:
      - "/bin/sh"
      - "-ec"
    args:
      - |
        cp /vault/config/extraconfig-from-values.hcl /tmp/storageconfig.hcl;
        [ -n "${HOST_IP}" ] && sed -Ei "s|HOST_IP|${HOST_IP?}|g" /tmp/storageconfig.hcl;
        [ -n "${POD_IP}" ] && sed -Ei "s|POD_IP|${POD_IP?}|g" /tmp/storageconfig.hcl;
        [ -n "${HOSTNAME}" ] && sed -Ei "s|HOSTNAME|${HOSTNAME?}|g" /tmp/storageconfig.hcl;
        [ -n "${API_ADDR}" ] && sed -Ei "s|API_ADDR|${API_ADDR?}|g" /tmp/storageconfig.hcl;
        [ -n "${TRANSIT_ADDR}" ] && sed -Ei "s|TRANSIT_ADDR|${TRANSIT_ADDR?}|g" /tmp/storageconfig.hcl;
        [ -n "${RAFT_ADDR}" ] && sed -Ei "s|RAFT_ADDR|${RAFT_ADDR?}|g" /tmp/storageconfig.hcl;
        /usr/local/bin/docker-entrypoint.sh vault server -config=/tmp/storageconfig.hcl
    ports:
      tcp:
        server: 5432

    env:
      - name: PGDATA
        value: /var/lib/postgresql/data/pgdata
    secrets:
      kreutzer-database:
        POSTGRES_PASSWORD: admin
    resources: {}

    initContainers:
      - name: data-migrator
        image:
          repository: postgres:15.1-alpine
        command:
          - /bin/sh
          - -c
        args:
          - '[ -e /var/lib/postgresql/data/postgresql.conf ] && [ ! -d /var/lib/postgresql/data/pgdata
            ] && mkdir -m 0700 /var/lib/postgresql/data/pgdata && mv /var/lib/postgresql/data/*
            /var/lib/postgresql/data/pgdata/ || true'
        resources: {}
      - name: data-permissions-ensurer
        image:
          repository: postgres
          tag: 15.1-alpine
        command:
          - /bin/sh
          - -c
        args:
          - chmod -R 700 /var/lib/postgresql/data/pgdata || true
        resources: {}
        volumeMounts:
          - mountPath: /var/lib/postgresql/data
            name: database-data
  vault:
    enabled: true
    type: StatefulSet
    image:
      repository: hashicorp/vault:1.12.2
    ports:
      http: 8200
      https: 8201
    configMaps:
      vault-config:
        type: File
        projectPath: conf/extraconfig-from-values.hcl
        mountPath: /vault/config/extraconfig-from-values.hcl
    lifecycle:
      preStop:
        exec:
          command:
            - "/bin/sh"
            - "-c"
            - "sleep 5 && kill -SIGTERM $(pidof vault)"

  dind:
    enabled: true
    type: StatefulSet
    image:
      repository: docker:dind
    ports:
      http: 2376
    securityContext:
      privileged: true

debug: false